image: jangrewe/gitlab-ci-android

stages:
  - build

variables:
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

before_script:
  # Install Java 17 (required for Android Gradle Plugin 8.1.0)
  - apt-get update -qq && apt-get install -y -qq openjdk-17-jdk
  - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  - export PATH=$JAVA_HOME/bin:$PATH
  - java -version
  - export GRADLE_USER_HOME=$(pwd)/.gradle
  - |
    if [ ! -f "./gradlew" ]; then
      echo "Gradle wrapper not found. Creating wrapper..."
      # Create gradle wrapper directory
      mkdir -p gradle/wrapper
      # Download Gradle wrapper JAR
      (wget -q https://raw.githubusercontent.com/gradle/gradle/v8.3.0/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar 2>/dev/null) || (curl -sL https://raw.githubusercontent.com/gradle/gradle/v8.3.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar)
      # Create gradle-wrapper.properties
      echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
      echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
      echo "distributionUrl=https\\://services.gradle.org/distributions/gradle-8.3-bin.zip" >> gradle/wrapper/gradle-wrapper.properties
      echo "networkTimeout=10000" >> gradle/wrapper/gradle-wrapper.properties
      echo "validateDistributionUrl=true" >> gradle/wrapper/gradle-wrapper.properties
      echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
      echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
      # Download proper gradlew script from Gradle
      (wget -q https://raw.githubusercontent.com/gradle/gradle/v8.3.0/gradlew -O gradlew 2>/dev/null) || (curl -sL https://raw.githubusercontent.com/gradle/gradle/v8.3.0/gradlew -o gradlew)
    fi
  - chmod +x ./gradlew

cache:
  key: ${CI_PROJECT_ID}
  paths:
    - .gradle/
    - gradle/wrapper/

build:
  stage: build
  script:
    - ./gradlew assembleDebug --no-daemon --stacktrace
  artifacts:
    paths:
      - app/build/outputs/apk/debug/app-debug.apk
    expire_in: 1 week
  only:
    - main
    - master
    - branches
